---
title: "LGM Abies"
author: "Nikos Tourvas"
date: "Date (ISO 8601): `r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: united
    toc: yes
  word_document: 
    toc: yes
---

### Load libraries
```{r}
library(popprxl)
library(hierfstat)
library(magrittr)
library(pegas)
library(mmod)
library(ape)
library(tidyverse)
library(ggplot2)
library(lattice)
```

# Import data set
```{r eval=FALSE, include=FALSE}
vignette('poppr_manual')
```

```{r import, cache=T}
obj <- read.genalexcel(
  "LGM_DE_SI_GR_final.xlsx", 
  sheet = "Abies", genclone = F)

# stratify data set
splitStrata(obj) <- ~Country/Pop
```

### Check for missing data
```{r missing, cache=F, fig.width=10, dpi=300}
info_table(obj, type = "missing", plot = TRUE)
```

```{r subset}
# Subset dataset (as standalone function or nested)
# s <- popsub(Abies_LifeGenMon, sublist =
#          c("Adult_GR_1_IN", "Adult_GR_1_EX"))
```

### Produce table
```{r table, cache=TRUE}
div <- poppr(obj, plot=F)
div <- div[,!names(div)%in%c("File","Hexp")]
Ho <- colMeans(basic.stats(obj)$Ho, na.rm=T)
Hs <- colMeans(basic.stats(obj)$Hs, na.rm=T)
Fis <- colMeans(basic.stats(obj)$Fis, na.rm=T)
div2 <- data.frame(Ho=Ho, Hs=Hs, Fis=Fis)
tots <- colMeans(div2)
div2 <- rbind(div2, tots)
div <- cbind(div, div2)
PA <- rowSums(private_alleles(obj, count.alleles=F))
PA <- data.frame(PA)
PA <- rbind(PA, Total=colSums(PA))
div <- cbind(div, PA)
row.names(div) <- NULL
is.num <- sapply(div, is.numeric)
div[is.num] <- lapply(div[is.num], round, 3)
knitr::kable(div)
```

# Private alleles

### Private alleles per population
```{r cache=TRUE, dpi=300, fig.width=8.5}
private <- private_alleles(obj, report = "data.frame")
ggplot(private) + geom_tile(aes(x = population, 
                                y = allele, 
                                fill = count)) +
  ggtitle("Private alleles per population")
```

```{r eval=FALSE, cache=TRUE, include=FALSE}
pal <- as.data.frame(private_alleles(obj, count.alleles = FALSE))
  pal$Sum <- rowSums(pal)

knitr::kable(pal)
```

### Private alleles per country
```{r cache=TRUE, dpi=300, fig.height=8}
private_countries <- private_alleles(obj, alleles ~ Country, report = "data.frame")
ggplot(private_countries) + geom_tile(aes(x = population, 
                                          y = allele, 
                                          fill = count)) +
  ggtitle("Private alleles per country")
```

```{r cache=TRUE}
pal_countries <- as.data.frame(private_alleles(obj, locus ~ Country, count.alleles = FALSE))
  pal_countries$Sum <- rowSums(pal_countries)

knitr::kable(pal_countries, caption = "Private alleles per country")
```

# Hardy - Weinberg equilibrium


### Calculate p-value for each locus of every pop

```{r cache=TRUE}
(hw.obj <- seppop(obj) %>% 
  lapply(hw.test, B = 1000))
# seppop: calculates p-value for each locus of every pop
# B: number of permutations
```

```{r Bonferroni-levelplot, fig.width=9, dpi=300,cache=TRUE}
# Isolate p-values either from chi2 test (j=3) or 
# from exact test (j=4)
hw.mat <- sapply(hw.obj, "[", i = TRUE, j = 4)
# Take the third/fourth column with all rows

# Multiple test correction (Holm-Bonferroni)
hw.holm.values <- p.adjust(hw.mat, method = "holm")
locinames <- rownames(hw.mat)
popnames <- colnames(hw.mat)

hw.holm.mat <- matrix(nrow = length(locNames(obj)),
                      ncol = length(popNames(obj)),
                      data = hw.holm.values, byrow = F)
rownames(hw.holm.mat) <- locinames
colnames(hw.holm.mat) <- popnames

levelplot(t(hw.holm.mat), aspect = "fill", xlab="Pop", ylab="Marker")

knitr::kable(hw.holm.mat, caption = "HWE p-values after Holm-Bonferroni correction")
```

```{r basic.stats, cache=T}
colMeans(basic.stats(obj)$Fis, na.rm = T)
# pops <- seppop(obj) 
# stats <- list()
# for(i in 1:length(pops)){
#   stats[[i]] <- basic.stats(pops[[i]])
# }
```

```{r ar_pops, fig.width=7, dpi=300, cache=T}
setPop(obj) <- ~Country/Pop

ar <- allelic.richness(obj)

# create data.frame for ggplot2
ar[["Ar"]] <- as.data.frame(ar[["Ar"]])
colnames(ar[["Ar"]]) <- popNames(obj)
ar[["Ar"]]$locus <- rownames(ar[["Ar"]])
ar[["Ar"]] <- gather(ar[["Ar"]], Population, Ar, -locus)

title <- paste("Allelic richness per population (rarefaction = ", ar[["min.all"]], "genes)")

ggplot(ar[["Ar"]], aes(x = Population, y = Ar)) +
  geom_boxplot() +
  theme_minimal() +
  ggtitle(title)
```

```{r ar_country, dpi=300, cache=T}
setPop(obj) <- ~Country

ar <- allelic.richness(obj)

# create data.frame for ggplot2
ar[["Ar"]] <- as.data.frame(ar[["Ar"]])
colnames(ar[["Ar"]]) <- popNames(obj)
ar[["Ar"]]$locus <- rownames(ar[["Ar"]])
ar[["Ar"]] <- gather(ar[["Ar"]], Population, Ar, -locus)

title <- paste("Allelic richness per population (rarefaction = ", ar[["min.all"]], "genes)")

ggplot(ar[["Ar"]], aes(x = Population, y = Ar)) +
  geom_boxplot() +
  theme_minimal() +
  ggtitle(title)
```

# Genetic differentiation

### Cavalli-Sforza

```{r cavalli-sforza, fig.width = 10, dpi=300, cache=T}

# set appropriate hierarchy
setPop(obj) <- ~Country/Pop

# Dendrogram using table provided by another package
Cav_Sf <- genet.dist(obj, method = "Dch") 
Cav_Sf <- as.matrix(Cav_Sf) # convert to matrix

# added because hierfstat doesn't display pop names by default
pop_vector <- popNames(obj)
colnames(Cav_Sf) <- pop_vector 
rownames(Cav_Sf) <- pop_vector

knitr::kable(Cav_Sf)

aboot(Cav_Sf, sample = 1000, cutoff = 50,
               tree = "upgma")

aboot(Cav_Sf, sample = 1000, cutoff = 50,
               tree = "nj")
```

### Nei distance hierfstat

```{r nei, fig.width = 10, dpi=300, cache=T}

# set appropriate hierarchy
setPop(obj) <- ~Country/Pop

# Dendrogram using table provided by another package
nei <- genet.dist(obj, method = "Ds") 
nei <- as.matrix(nei) # convert to matrix

# added because hierfstat doesn't display pop names by default
pop_vector <- popNames(obj)
colnames(nei) <- pop_vector 
rownames(nei) <- pop_vector

knitr::kable(nei)

set.seed(1994)
aboot(nei, sample = 1000, cutoff = 50,
               tree = "upgma")

aboot(nei, sample = 1000, cutoff = 50,
               tree = "nj")
```

### Nei distance 1972 1978 poppr

```{r nei, fig.width = 10, dpi=300, cache=T}

# set appropriate hierarchy
setPop(obj) <- ~Country/Pop

set.seed(1994)

aboot(obj, sample = 1000, cutoff = 50,
               tree = "upgma", distance = "nei.dist")

# aboot(obj, sample = 1000, cutoff = 50,
#                tree = "nj", distance = "nei.dist")
```

Make table with Ho He using adegenet's summary function. Also include in the table HWE , N of alleles, Ne of alleles

In F~ST~ it would be advisable to also display standard error (Meirmans)

# Reproducibility

```{r reproducibility}
devtools::session_info()
```